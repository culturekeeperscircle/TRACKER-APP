name: Manual Tracker Update

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source to fetch from'
        required: true
        type: choice
        options:
          - all
          - federal_register
          - congress
          - courtlistener
          - news
      lookback_days:
        description: 'Days to look back'
        required: true
        default: '7'
      dry_run:
        description: 'Dry run (no commit)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  manual-update:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt

      - name: Run pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CONGRESS_API_KEY: ${{ secrets.CONGRESS_API_KEY }}
          COURTLISTENER_TOKEN: ${{ secrets.COURTLISTENER_TOKEN }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          LOOKBACK_DAYS: ${{ github.event.inputs.lookback_days }}
          SOURCE_FILTER: ${{ github.event.inputs.source }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: python -m pipeline

      - name: Commit if not dry run
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "TCKC Pipeline Bot"
          git config user.email "pipeline@culturekeeperscircle.org"
          git add data/data.json data/state.json index.html
          git diff --staged --quiet || git commit -m "Manual update from ${{ github.event.inputs.source }} [$(date +%Y-%m-%d)]"
          git push

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manual-log-${{ github.run_id }}
          path: pipeline/logs/
          retention-days: 30
